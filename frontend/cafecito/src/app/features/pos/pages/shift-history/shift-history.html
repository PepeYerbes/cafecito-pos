<section class="container" *ngIf="!loading(); else loadingTpl">
  <header class="header">
    <h2>Historial de cierres</h2>
    <a routerLink="/pos" class="link">← Volver</a>
  </header>

  <form class="filters" (submit)="buscar($event)">
    <label>Desde
      <input type="date" [ngModel]="from()" (ngModelChange)="from.set($event)" name="from" />
    </label>
    <label>Hasta
      <input type="date" [ngModel]="to()" (ngModelChange)="to.set($event)" name="to" />
    </label>
    <button class="secondary" type="submit">Filtrar</button>
  </form>

  <div class="table-wrap" *ngIf="items().length; else emptyTpl">
    <table class="table">
      <thead>
      <tr>
        <th>Fecha cierre</th>
        <th>Total</th>
        <th>Efectivo</th>
        <th>Tarjeta</th>
        <th>Mixto</th>
        <th></th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let s of items()">
        <td>{{ s.closedAt | date:'short' }}</td>
        <td>{{ s.totals?.total || 0 | currency:'MXN' }}</td>

        <!-- ✅ Usar helpers; nada de arrow functions en template -->
        <td>{{ paymentTotal(s, 'CASH')  | currency:'MXN' }}</td>
        <td>{{ paymentTotal(s, 'CARD')  | currency:'MXN' }}</td>
        <td>{{ paymentTotal(s, 'MIXED') | currency:'MXN' }}</td>

        <td>
          <a [routerLink]="['/pos/shift-detail', s._id]" class="link">Detalle</a>
          &nbsp;|&nbsp;
          <a [href]="'/api/cash/register/'+s._id+'/report?format=pdf'" target="_blank" class="link">PDF</a>
        </td>
      </tr>
      </tbody>
    </table>

    <nav class="pager">
      <button (click)="go(page()-1)" [disabled]="page()===1">Anterior</button>
      <span>{{ page() }} / {{ pages() }}</span>
      <button (click)="go(page()+1)" [disabled]="page()===pages()">Siguiente</button>
    </nav>
  </div>

  <ng-template #emptyTpl>
    <div class="card">No hay cierres para los filtros seleccionados.</div>
  </ng-template>
</section>

<ng-template #loadingTpl>
  <div class="container"><div class="card">Cargando…</div></div>
</ng-template>