<!-- src/app/features/pos/pages/shift-history/shift-history.html -->
<section class="container" *ngIf="!loading(); else loadingTpl">
  <header class="header">
    <h2>Historial de cierres</h2>
    <a routerLink="/pos" class="link">‚Üê Volver</a>
  </header>

  <form class="filters" (submit)="buscar($event)">
    <label>Desde
      <input type="date" [ngModel]="from()" (ngModelChange)="from.set($event)" name="from" />
    </label>
    <label>Hasta
      <input type="date" [ngModel]="to()" (ngModelChange)="to.set($event)" name="to" />
    </label>
    <button class="secondary" type="submit">Filtrar</button>
  </form>

  <div class="table-wrap" *ngIf="items().length; else emptyTpl">
    <table class="table">
      <thead>
        <tr>
          <th>Fecha cierre</th>
          <th>Cajero</th>
          <th>Total</th>
          <th>Efectivo</th>
          <th>Tarjeta</th>
          <th>Mixto</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let s of items()">
          <td>{{ s.closedAt | date:'short' }}</td>

          <!-- ‚úÖ Nombre del cajero -->
          <td class="cashier-cell">
            <span class="cashier-badge">üë§ {{ cashierName(s) }}</span>
          </td>

          <td>{{ s.totals?.total || 0 | currency:'MXN' }}</td>
          <td>{{ paymentTotal(s, 'CASH')  | currency:'MXN' }}</td>
          <td>{{ paymentTotal(s, 'CARD')  | currency:'MXN' }}</td>
          <td>{{ paymentTotal(s, 'MIXED') | currency:'MXN' }}</td>

          <td class="actions-cell">
            <a [routerLink]="['/pos/shift-detail', s._id]" class="link">Detalle</a>
            &nbsp;|&nbsp;
            <!-- ‚úÖ FIX: bot√≥n con descarga via HTTP (lleva el token JWT) -->
            <button
              class="link-btn"
              [disabled]="downloadingId() === s._id"
              (click)="downloadPdf(s._id)">
              {{ downloadingId() === s._id ? '‚è≥ Descargando‚Ä¶' : 'PDF' }}
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <nav class="pager">
      <button (click)="go(page()-1)" [disabled]="page()===1">Anterior</button>
      <span>{{ page() }} / {{ pages() }}</span>
      <button (click)="go(page()+1)" [disabled]="page()===pages()">Siguiente</button>
    </nav>
  </div>

  <ng-template #emptyTpl>
    <div class="card">No hay cierres para los filtros seleccionados.</div>
  </ng-template>
</section>

<ng-template #loadingTpl>
  <div class="container"><div class="card">Cargando‚Ä¶</div></div>
</ng-template>